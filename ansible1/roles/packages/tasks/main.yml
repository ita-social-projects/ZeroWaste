---
- name: Update apt cache.
  apt:
    update_cache: true
    cache_valid_time: 86400

- name: Install system dependencies
  apt:
    name:
      - libvips42
      - libvips-dev
      - imagemagick
    state: present

# - name: Include OS-specific variables.
#   include_vars: "{{ ansible_os_family }}.yml"

- name: Install ruby and other required dependencies.
  apt:
    name: "{{ item }}"
    state: present
  with_items: "{{ ruby_packages  }}"

- name: Install rubygems.
  apt:
    name: "{{ ruby_rubygems_package_name }}"
    state: present

# - name: Define ruby_build_packages
#   set_fact:
#     ruby_build_packages: "{{ __ruby_build_packages }}"
#   when: ruby_build_packages is not defined

- name: Get the username
  become: false
  local_action: command whoami
  register: username_on_the_host

# - name: Install Debian packages
#   import_tasks: "setup-Debian.yml"
#   become: yes

- name: Install Ruby and Gems
  import_tasks: "rvm.yml"
  become: yes
  become_user: "{{ username_on_the_host.stdout }}"

- name: Install RVM
  import_tasks: "rubies.yml"
  become: yes
  become_user: "{{ username_on_the_host.stdout }}"

- name: Add Yarn GPG key
  apt_key:
    url: https://dl.yarnpkg.com/debian/pubkey.gpg
    state: present

# Install ruby from source when ruby_install_from_source is true.
# - include_tasks: install-from-source.yml
#   when: ruby_install_from_source

- name: Add user installed RubyGems bin directory to global $PATH
  copy:
    src: rubygems.sh
    dest: /etc/profile.d/rubygems.sh
    mode: 644

- name: Ensure RVM is sourced
  shell: source ~/.rvm/scripts/rvm
  args:
    executable: /bin/bash
  become_user: "{{ username_on_the_host.stdout }}"

- name: Install Bundler gem
  shell: |
    ~/.rvm/bin/rvm use 3.3.5 do gem install bundler
  args:
    creates: ~/.rvm/gems/ruby-3.3.5/bin/bundler
  become_user: "{{ username_on_the_host.stdout }}"

- name: Run bundle install with Gemfile
  shell: |
    ~/.rvm/bin/rvm use 3.3.5 do bundle install --gemfile Gemfile
  args:
    chdir: "/home/{{ username_on_the_host.stdout }}/ZeroWaste/"
  become_user: "{{ username_on_the_host.stdout }}"

- name: Run rake db:migrate
  shell: |
    ~/.rvm/bin/rvm use 3.3.5 do rake db:migrate
  become: yes
  become_user: "{{ username_on_the_host.stdout }}"
  args:
    chdir: "/home/{{ username_on_the_host.stdout }}/ZeroWaste/"
# Install Bundler and configured gems
# - name: Install Bundler
#   gem:
#     name: bundler
#     state: present
#     user_install: false
#   when: ruby_install_bundler

# - name: Install configured gems
#   gem:
#     name: "{{ item.name | default(item) }}"
#     version: "{{ item.version | default(omit) }}"
#     user_install: false
#     state: present
#   become: true
#   become_user: "{{ ruby_install_gems_user }}"
#   with_items: "{{ ruby_install_gems }}"

# - name: Install development gems
#   gem:
#     name: "{{ item.name }}"
#     version: "{{ item.version | default(omit) }}"
#     user_install: false
#   with_items:
#     - { name: "pry-rails" }
#     - { name: "letter_opener" }
#     - { name: "web-console", version: ">= 4.1.0" }
#   when: ruby_install_gems_development
