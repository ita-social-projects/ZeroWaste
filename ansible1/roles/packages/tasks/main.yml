---
- name: Update apt cache.
  apt:
    update_cache: true
    cache_valid_time: 86400

- name: Install system dependencies
  apt:
    name:
      - libvips42
      - libvips-dev
      - imagemagick
    state: present

- name: Include OS-specific variables.
  include_vars: "{{ ansible_os_family }}.yml"

# - name: Define ruby_build_packages
#   set_fact:
#     ruby_build_packages: "{{ __ruby_build_packages }}"
#   when: ruby_build_packages is not defined

- name: Update apt cache (Debian)
  apt: update_cache=true cache_valid_time=86400
  when: ansible_os_family == 'Debian'

- name: Get the username
  become: false
  local_action: command whoami
  register: username_on_the_host

- name: Install Debian packages
  import_tasks: "setup-Debian.yml"
  become: yes

- name: Install Ruby and Gems
  import_tasks: "rvm.yml"
  become: yes
  become_user: "{{ username_on_the_host.stdout }}"

- name: Install RVM
  import_tasks: "rubies.yml"
  become: yes
  become_user: "{{ username_on_the_host.stdout }}"

- name: Add Yarn GPG key
  apt_key:
    url: https://dl.yarnpkg.com/debian/pubkey.gpg
    state: present

# Install ruby from source when ruby_install_from_source is true.
# - include_tasks: install-from-source.yml
#   when: ruby_install_from_source

- name: Add user installed RubyGems bin directory to global $PATH
  copy:
    src: rubygems.sh
    dest: /etc/profile.d/rubygems.sh
    mode: 644

# Install Bundler and configured gems
- name: Install Bundler
  gem:
    name: bundler
    state: present
    user_install: false
  when: ruby_install_bundler

- name: Install configured gems
  gem:
    name: "{{ item.name | default(item) }}"
    version: "{{ item.version | default(omit) }}"
    user_install: false
    state: present
  become: true
  become_user: "{{ ruby_install_gems_user }}"
  with_items: "{{ ruby_install_gems }}"

- name: Install development gems
  gem:
    name: "{{ item.name }}"
    version: "{{ item.version | default(omit) }}"
    user_install: false
  with_items:
    - { name: "pry-rails" }
    - { name: "letter_opener" }
    - { name: "web-console", version: ">= 4.1.0" }
  when: ruby_install_gems_development
